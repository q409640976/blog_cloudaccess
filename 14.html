<!DOCTYPE html>
<html lang="en-US"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Cloudflare 动态域名解析设置全过程，及二级域名ID的获取 – fast ok</title><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel="dns-prefetch" href="//s.w.org"><link rel="stylesheet" id="wp-block-library-css" href="https://liming.imfast.io/wp-includes/css/dist/block-library/style.min.css" type="text/css" media="all"><link rel="stylesheet" id="friendly-lite-google-opensans-css" href="http://fonts.googleapis.com/css?family=Open+Sans%3A300%2C300i%2C400%2C400i%2C600%2C600i%2C700%2C700i%2C800%2C800i&ver=5.4" type="text/css" media="all"><link rel="stylesheet" id="friendly-lite-google-raleway-css" href="https://fonts.googleapis.com/css?family=Raleway%3A100%2C100i%2C200%2C200i%2C300%2C300i%2C400%2C400i%2C500%2C500i%2C600%2C600i%2C700%2C700i%2C800%2C800i%2C900%2C900i&ver=5.4" type="text/css" media="all"><link rel="stylesheet" id="friendly-lite-google-ubuntu-mono-css" href="https://fonts.googleapis.com/css?family=Ubuntu+Mono%3A400%2C400i%2C700%2C700i&ver=5.4" type="text/css" media="all"><link rel="stylesheet" id="font-awesome-css" href="https://liming.imfast.io/wp-content/themes/friendly-lite//assets/css/font-awesome.min.css" type="text/css" media="all"><link rel="stylesheet" id="bootstrap-css" href="https://liming.imfast.io/wp-content/themes/friendly-lite//assets/css/bootstrap.min.css" type="text/css" media="all"><link rel="stylesheet" id="friendly-lite-style-css" href="https://liming.imfast.io/wp-content/themes/friendly-lite//style.css" type="text/css" media="all"><script type="text/javascript" src="https://liming.imfast.io/wp-includes/js/jquery/jquery.js"></script><script type="text/javascript" src="https://liming.imfast.io/wp-includes/js/jquery/jquery-migrate.min.js"></script><style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style><style type="text/css" id="friendly-lite-customizer-style">
				.hero-img-off .site-branding,
				.hero-img-off .site-description,
				.hero-img-off .site-title,
				.hero-img-off .site-title a,
				.hero-img-off .site-title a:hover,
				.hero-img-off .site-title a:focus {
					color: #0b448b				}
		</style></head><body class="post-template-default single single-post postid-14 single-format-standard singular-post">

	
			<div class="pre-loader"></div>
	
	<a href="#content" class="skip-link screen-reader-text">Skip To Content</a>
	<div id="page-wrapper" class="hfeed site">
		
		<header id="masthead" class="site-header hero-img-off" role="banner"><section class="header-top"><div id="topbar-wrapper" class="collapse in">
		<div class="container">
			<div class="row">
				<div class="col-md-8 topbar-left">
					<ul class="contact-links"></ul></div>
									<div class="col-md-4 topbar-right">	
						<ul class="header-social-icons"></ul></div>
							</div>
		</div>

	</div>
	<a href="#topbar-wrapper" data-toggle="collapse" id="toggle-topbar" class="topbar-toggle-btn" aria-expanded="false" aria-label="Toggle Top Bar">
		<i class="fa fa-angle-up" aria-hidden="true" title="Toggle Top Bar"></i>
	</a>
</section><section class="custom-header"><div class="custom-header-media">
			</div>
	
	<div class="site-branding">
											<div class="site-logo"></div>	
						<div class="site-info">
																<p class="site-title">
								<a href="https://liming.imfast.io/" rel="home">fast ok</a>
							</p>
																			<p class="site-description">one month</p>
							</div>
			</div>
</section></header><section class="breadcrumb-wrapper"><div class="container">
			<ol class="breadcrumb"><li class="breadcrumb-item"><a href="https://liming.imfast.io">Home</a></li><li class="breadcrumb-item"><a href="https://liming.imfast.io/category/uncategorized">默认分类</a></li><li class="breadcrumb-item active">Cloudflare 动态域名解析设置全过程，及二级域名ID的获取</li></ol></div></section><div id="content" class="site-content">
<div class="container">
	<div class="row">
		<div id="primary" class="col-md-9 content-area">
			<main id="main" class="site-main" role="main"><article id="post-14" class="post-14 post type-post status-publish format-standard hentry category-uncategorized"><header class="entry-header"><h1 class="entry-title">Cloudflare 动态域名解析设置全过程，及二级域名ID的获取</h1><div class="entry-meta"><span class="byline"><i class="fa fa-user-circle" aria-hidden="true"></i><span class="screen-reader-text">Posted By: </span><span class="author vcard"><a class="url fn n" href="https://liming.imfast.io/author/apvffqbd">admin</a></span></span><span class="posted-on"><i class="fa fa-calendar" aria-hidden="true"></i><span class="screen-reader-text">Posted On: </span><a href="https://liming.imfast.io/14.html" rel="bookmark"><time class="entry-date updated" datetime="2020-04-25T07:49:03+08:00">2020-04-25</time></a></span></div>	</header><div class="entry-content">
		<div>
<p>Cloudflare 动态域名解析设置全过程，及二级域名ID的获取。首先，Dnspod的动态域名设置很简单，反过来说，也是因为功能有限，所以才简单。</p>
<pre>#获取domain_id
curl -X POST https://dnsapi.cn/Domain.Info  -d 'login_token=13834,fe01aa05aded8ada9c3e984fb6144cd7&format=json&domain=uselys.cn'

#获取record_id
curl -X POST https://dnsapi.cn/Record.List -d 'login_token=13834,fe01aa05aded8ada9c3e984fb6144cd7&format=json&domain=uselys.cn'

#提交域名更新。每小时限5次。
curl -s -X POST https://dnsapi.cn/Record.Ddns -d 'login_token=13834,fe01aa05aded8ada9c3e984fb6144cd7&format=json&domain=uselys.cn&record_id=184261226&record_line=默认&sub_domain=home'</pre>
<p>就这么三步，燃鹅国产dns的问题，大家也都心知肚明。还有那些花生壳之类的，真要用在生产环境下要多纠结有多纠结，跑起来晃悠悠的，死起来直挺挺的。</p>
<p>所以Cloudflare动态域名解析才是我们真正需要的。用的人不多的主要原因，可能是在获取二级域名的id的麻烦上，确实很难受。</p>
<blockquote>
<p> https://api.cloudflare.com/</p>
<p>Cloudflare API手册，是必备工具，里面详细写明了几乎所有功能的用法。不过要理解的话，必须照着手册去试错。</p>
</blockquote>
<h2>设置教程</h2>
<p>1. 主机里必须安装 curl, 这是跟API通讯的基本工具。</p>
<p>2. 获取域名的Zone ID、账号Email、API Keys(我直接使用Global API Key)。</p>
<p>3. 获取二级域名的ID号，这是最眼花缭乱的一步，很多朋友大概就止步于此。 首先要先设置一个二级域名，比如home.uselys.cn ，IP地址随便填，记住这个 home。 </p>
<figure data-trix-attachment='{"contentType":"image/jpg","contenteditable":false,"height":90,"url":"https://static.wangdalao.com/wp-content/uploads/2020/04/191aec537b57f7_1_post.jpg","width":1035}' data-trix-content-type="image/jpg" data-trix-attributes='{"presentation":"gallery"}' class="attachment attachment--preview"><img src="https://static.wangdalao.com/wp-content/uploads/2020/04/191aec537b57f7_1_post.jpg" width="1035" height="90"></figure><p>然后获取home的ID号：</p>
<pre>https://api.cloudflare.com/#dns-records-for-a-zone-list-dns-records</pre>
<p>上面是说明书的具体章节。然后是命令样本：</p>
<pre>curl -X GET "https://api.cloudflare.com/client/v4/zones/023e105f4ecef8ad9ca31a8372d0c353/dns_records?type=A&name=example.com&content=127.0.0.1&page=1&per_page=20&order=type&direction=desc&match=all"<ol><li>

</li><li>     -H "X-Auth-Email: user@example.com"</li><li>

</li><li>     -H "X-Auth-Key: c2547eb745079dac9320b638f5e225cf483cc5cfdda41" </li><li>     -H "Content-Type: application/json"</li></ol></pre>
<p>我一开始总是把 Zone Details 和 List DNS Records 搞错，实际上是 List DNS Records。</p>
<pre>/zones/023e105f4ecef8ad9ca31a8372d0c353</pre>
<p>这一段 /zones/ 后面的字符串改成 域名的ID号</p>
<pre>/dns_records?type=A&name=example.com&content=127.0.0.1&page=1&per_page=20&order=type&direction=desc&match=all" </pre>
<p>这一段只需要保留问号前面的内容，问号后面都是参数，实际上我们用不着。</p>
<p>结果就是这样：</p>
<pre>curl -X GET<ol><li>"https://api.cloudflare.com/client/v4/zones/023e105f4ecef8ad9ca31a8372d0c353/dns_records"</li></ol></pre>
<p>X-Auth-Email 和 X-Auth-Key 改成自己的实际参数就好了。 最终，命令是这样的：</p>
<pre>curl -X GET "https://api.cloudflare.com/client/v4/zones/cc837e5e8b25acc36fab40fdf98dcaf9/dns_records"     -H "X-Auth-Email: service@uselys.cn"  -H "X-Auth-Key: a79efe70d7bcdc3rd4763676f3437e412f002" -H "Content-Type: application/json" </pre>
<p>记得把发斜杠去掉，做成一个一行命令，然后在命令行执行，结果如下：</p>
<pre>{"result":[{"id":"a3365e7fa46ec326cf8ca153e6d7fe5c","type":"A","name":"home.uselys.cn","content":"111.111.111.111","proxiable":true,"proxied":false,"ttl":1,"locked":false<ol><li>......</li></ol></pre>
<p>home.uselys.cn 前面的id值 a3365e7fa46ec326cf8ca153e6d7fe5c 就是二级域名 home 的id。 到此，参数配齐了！</p>
<p>4. 获取本机IP</p>
<pre>curl -s http://whatismyip.akamai.com</pre>
<p>获取本机IP的方式有很多种，这种比较直观把。 </p>
<p>5. 更新 home 的IP，说明书具体章节：</p>
<pre>https://api.cloudflare.com/#dns-records-for-a-zone-update-dns-record</pre>
<p>章节名称是：Update DNS Record</p>
<p>命令样本：</p>
<pre>curl -X PUT "https://api.cloudflare.com/client/v4/zones/023e105f4ecef8ad9ca31a8372d0c353/dns_records/372e67954025e0ba6aaa6d586b9e0b59" 
     -H "X-Auth-Email: user@example.com" 

     -H "X-Auth-Key: c2547eb745079dac9320b638f5e225cf483cc5cfdda41" 

     -H "Content-Type: application/json" 
     --data '{"type":"A","name":"example.com","content":"127.0.0.1","ttl":120,"proxied":false}'</pre>
<p>这时候，所有的参数我们都已经知道，把对应的参数都修改成自己的实际参数即可。然后把 content 的值换成 222.222.222.222 试试看。如果成功了，这一步就算完成了。</p>
<p>6. 把获取IP、更改IP连个步骤组合成一个sh脚本：</p>
<pre>API_URL=$(/usr/local/bin/curl -s http://whatismyip.akamai.com)
/usr/local/bin/curl -s -X PUT "https://api.cloudflare.com/client/v4/zones/cc837e5e8b25acc36fab40fdf98dcaf9/dns_records/a3365e7fa46ec326cf8ca153e6d7fe5c" 
     -H "X-Auth-Email: service@uselys.cn" 
     -H "X-Auth-Key: a79efe70d7bcdc3rd4763676f3437e412f002" 
     -H "Content-Type: application/json" 
     --data "{"type":"A","name":"source","content":"$API_URL","ttl":300,"proxied":false}" 
     > /dev/null</pre>
<p>注意，content 的参数换成了 变量 $API_URL。 保存为 cf.sh，并给它赋予执行权限。 如此一来，每执行一次，home.uselys.cn 的IP就更新一次。</p>
<p>7. 最后一步，把 cf.sh 放到 crontab 里面，按照你设想的时间频率运行即可。</p>
<p>本文转自 @ <a href="https://www.uselys.cn/thread-25-1-1.html">南汇网络</a> </p>
</div>
	</div>
	<footer class="entry-footer"><span class="cat-links"><i class="fa fa-folder-open" aria-hidden="true"></i><span class="screen-reader-text">Categories: </span><a href="https://liming.imfast.io/category/uncategorized" rel="category tag">默认分类</a></span>	</footer></article><nav class="navigation post-navigation" role="navigation" aria-label="Continue Reading"><h2 class="screen-reader-text">Continue Reading</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://liming.imfast.io/13.html" rel="prev"><span class="screen-reader-text">Previous Post</span><span aria-hidden="true" class="nav-subtitle">Previous</span> <span class="nav-title">桔子VPS美国洛杉矶三网CN2 GIA 1核1G 50M带宽低至5折47元/月 附速度及综合性能测评</span></a></div><div class="nav-next"><a href="https://liming.imfast.io/15.html" rel="next"><span class="screen-reader-text">Next Post</span><span aria-hidden="true" class="nav-subtitle">Next</span><span class="nav-title">幕布四周年活动，最少4个月高级版会员~</span></a></div></div>
	</nav>Comments are closed.<p class="no-comment"></p>			</main></div>
		<div id="secondary" class="col-md-3 primary-sidebar" role="complementary">
	<div class="widget-wrapper">
		<div id="search-2" class="widget widget_search">
<form role="search" method="get" class="search-form" action="https://liming.imfast.io/">
	<label for="search-input-5ea9549b244e6">
		<span class="screen-reader-text">
			Search for:		</span>
	</label>
	<input type="text" id="search-input-5ea9549b244e6" class="form-control" placeholder="Search …" value="" name="s"><button type="submit" class="btn btn-search">
		<i class="fa fa-search" aria-hidden="true"></i>
		<span class="screen-reader-text">
			Search		</span>
	</button>
</form>
</div>		<div id="recent-posts-2" class="widget widget_recent_entries">		<h2 class="widget-title">Recent Posts</h2>		<ul><li>
					<a href="https://liming.imfast.io/16.html">XREA 日本免费虚拟主机及 .shop 免费域名（稳定多年）</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/15.html">幕布四周年活动，最少4个月高级版会员~</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/14.html" aria-current="page">Cloudflare 动态域名解析设置全过程，及二级域名ID的获取</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/13.html">桔子VPS美国洛杉矶三网CN2 GIA 1核1G 50M带宽低至5折47元/月 附速度及综合性能测评</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/12.html">Name.com 免费一年域名：.live .games .ninja .video .wtf</a>
									</li>
					</ul></div><div id="recent-comments-2" class="widget widget_recent_comments"><h2 class="widget-title">Recent Comments</h2><ul id="recentcomments"></ul></div><div id="archives-2" class="widget widget_archive"><h2 class="widget-title">Archives</h2>		<ul><li><a href="https://liming.imfast.io/date/2020/04">April 2020</a></li>
		</ul></div><div id="categories-2" class="widget widget_categories"><h2 class="widget-title">Categories</h2>		<ul><li class="cat-item cat-item-1"><a href="https://liming.imfast.io/category/uncategorized">默认分类</a>
</li>
		</ul></div><div id="meta-2" class="widget widget_meta"><h2 class="widget-title">Meta</h2>			<ul><li><a href="https://liming.imfast.io/wp-login.php">Log in</a></li>
			<li><a href="https://liming.imfast.io/feed">Entries feed</a></li>
			<li><a href="https://liming.imfast.io/comments/feed">Comments feed</a></li>
			<li><a href="https://wordpress.org/">WordPress.org</a></li>			</ul></div>	</div>
</div>
	</div>
</div>
	</div>

	<footer id="colophon" class="site-footer"><div class="footer-widgets">
			<div class="container">
				<div class="row">
						<div class="col-md-4  widget-wrapper">
			</div>
	<div class="col-md-4  widget-wrapper">
				<div class="widget widget_recent_entries">		<h2 class="widgettitle">Recent Posts</h2>		<ul><li>
					<a href="https://liming.imfast.io/16.html">XREA 日本免费虚拟主机及 .shop 免费域名（稳定多年）</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/15.html">幕布四周年活动，最少4个月高级版会员~</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/14.html" aria-current="page">Cloudflare 动态域名解析设置全过程，及二级域名ID的获取</a>
									</li>
					</ul></div>	</div>
	<div class="col-md-4  widget-wrapper">
		<div class="widget widget_recent_comments"><h2 class="widgettitle">Recent Comments</h2><ul id="recentcomments--1"></ul></div>	</div>
				</div>	
			</div> 
		</div> 
		<div class="footer-social-copyright">	
			<div class="container">
				<div class="row">
						<div class="social-icons col-lg-6 col-md-6 col-sm-12 text-left">
		<ul class="list-inline footer-social-icons"></ul></div>
<div class="site-copyright col-lg-6 col-md-6 col-sm-12 text-right">
	Copyright © 2020<span class="sep"> | </span>
<a href="https://wordpress.org/">
	Proudly powered by WordPress</a>
</div>
				</div>	
			</div> 
		</div>	
	</footer></div>


 
		<button type="button" id="scroll-up" class="btn-scroll-up">
			<span class="screen-reader-text">Scroll up to top</span>
		</button> 


<script type="text/javascript" src="https://liming.imfast.io/wp-content/themes/friendly-lite//assets/js/bootstrap.min.js"></script><script type="text/javascript" src="https://liming.imfast.io/wp-content/themes/friendly-lite//assets/js/skip-link-focus-fix.js"></script><script type="text/javascript">
/* <![CDATA[ */
var friendly_lite_js_obj = {"site_preloader":"1","back_to_top":"1"};
/* ]]> */
</script><script type="text/javascript" src="https://liming.imfast.io/wp-content/themes/friendly-lite//assets/js/friendly-lite.js"></script></body></html>
