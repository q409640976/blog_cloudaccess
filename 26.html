<!DOCTYPE html>
<html lang="en-US"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>Kubernetes: proxy requests without additional pods – fast ok</title><link rel="dns-prefetch" href="//fonts.googleapis.com"><link rel="dns-prefetch" href="//s.w.org"><link rel="stylesheet" id="wp-block-library-css" href="https://liming.imfast.io/wp-includes/css/dist/block-library/style.min.css" type="text/css" media="all"><link rel="stylesheet" id="friendly-lite-google-opensans-css" href="http://fonts.googleapis.com/css?family=Open+Sans%3A300%2C300i%2C400%2C400i%2C600%2C600i%2C700%2C700i%2C800%2C800i&ver=5.4" type="text/css" media="all"><link rel="stylesheet" id="friendly-lite-google-raleway-css" href="https://fonts.googleapis.com/css?family=Raleway%3A100%2C100i%2C200%2C200i%2C300%2C300i%2C400%2C400i%2C500%2C500i%2C600%2C600i%2C700%2C700i%2C800%2C800i%2C900%2C900i&ver=5.4" type="text/css" media="all"><link rel="stylesheet" id="friendly-lite-google-ubuntu-mono-css" href="https://fonts.googleapis.com/css?family=Ubuntu+Mono%3A400%2C400i%2C700%2C700i&ver=5.4" type="text/css" media="all"><link rel="stylesheet" id="font-awesome-css" href="https://liming.imfast.io/wp-content/themes/friendly-lite//assets/css/font-awesome.min.css" type="text/css" media="all"><link rel="stylesheet" id="bootstrap-css" href="https://liming.imfast.io/wp-content/themes/friendly-lite//assets/css/bootstrap.min.css" type="text/css" media="all"><link rel="stylesheet" id="friendly-lite-style-css" href="https://liming.imfast.io/wp-content/themes/friendly-lite//style.css" type="text/css" media="all"><script type="text/javascript" src="https://liming.imfast.io/wp-includes/js/jquery/jquery.js"></script><script type="text/javascript" src="https://liming.imfast.io/wp-includes/js/jquery/jquery-migrate.min.js"></script><style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style><style type="text/css" id="friendly-lite-customizer-style">
				.hero-img-off .site-branding,
				.hero-img-off .site-description,
				.hero-img-off .site-title,
				.hero-img-off .site-title a,
				.hero-img-off .site-title a:hover,
				.hero-img-off .site-title a:focus {
					color: #0b448b				}
		</style></head><body class="post-template-default single single-post postid-26 single-format-standard singular-post">

	
			<div class="pre-loader"></div>
	
	<a href="#content" class="skip-link screen-reader-text">Skip To Content</a>
	<div id="page-wrapper" class="hfeed site">
		
		<header id="masthead" class="site-header hero-img-off" role="banner"><section class="header-top"><div id="topbar-wrapper" class="collapse in">
		<div class="container">
			<div class="row">
				<div class="col-md-8 topbar-left">
					<ul class="contact-links"></ul></div>
									<div class="col-md-4 topbar-right">	
						<ul class="header-social-icons"></ul></div>
							</div>
		</div>

	</div>
	<a href="#topbar-wrapper" data-toggle="collapse" id="toggle-topbar" class="topbar-toggle-btn" aria-expanded="false" aria-label="Toggle Top Bar">
		<i class="fa fa-angle-up" aria-hidden="true" title="Toggle Top Bar"></i>
	</a>
</section><section class="custom-header"><div class="custom-header-media">
			</div>
	
	<div class="site-branding">
											<div class="site-logo"></div>	
						<div class="site-info">
																<p class="site-title">
								<a href="https://liming.imfast.io/" rel="home">fast ok</a>
							</p>
																			<p class="site-description">one month</p>
							</div>
			</div>
</section></header><section class="breadcrumb-wrapper"><div class="container">
			<ol class="breadcrumb"><li class="breadcrumb-item"><a href="https://liming.imfast.io">Home</a></li><li class="breadcrumb-item"><a href="https://liming.imfast.io/category/uncategorized">默认分类</a></li><li class="breadcrumb-item active">Kubernetes: proxy requests without additional pods</li></ol></div></section><div id="content" class="site-content">
<div class="container">
	<div class="row">
		<div id="primary" class="col-md-9 content-area">
			<main id="main" class="site-main" role="main"><article id="post-26" class="post-26 post type-post status-publish format-standard hentry category-uncategorized"><header class="entry-header"><h1 class="entry-title">Kubernetes: proxy requests without additional pods</h1><div class="entry-meta"><span class="byline"><i class="fa fa-user-circle" aria-hidden="true"></i><span class="screen-reader-text">Posted By: </span><span class="author vcard"><a class="url fn n" href="https://liming.imfast.io/author/apvffqbd">admin</a></span></span><span class="posted-on"><i class="fa fa-calendar" aria-hidden="true"></i><span class="screen-reader-text">Posted On: </span><a href="https://liming.imfast.io/26.html" rel="bookmark"><time class="entry-date updated" datetime="2020-04-29T19:12:25+08:00">2020-04-29</time></a></span></div>	</header><div class="entry-content">
		<div>
<p>Sometimes you need to provide a legacy access to various downloads or proxy some requests to a different endpoint, that might not be running in your cluster. One can natively redirect such requests with having to add additional deployments / containers to your Kubernetes cluster.</p>
<p>There is a special type of Kubernete’s service object that simply points any traffic to that external DNS name. This <a href="https://github.com/kubernetes/website/issues/5822">isn’t really document</a> all too well but eventually you will find enough issues and pointers to frankenstein a solution together. For anybody else looking on how to do this correctly, here is run down with nginx-ingress-controller:0.19.0 that worked for me.</p>
<p>First we create a normal ingress object, that allows us to terminate the SSL and look into the path of the HTTP request and decide if this is a request that is relevant to be proxied. </p>
<pre class="wp-block-code"><code lang="yaml" class="language-yaml">apiVersion: extensions/v1beta1
kind: Ingress
metadata:
  annotations:
    kubernetes.io/ingress.class: nginx
    kubernetes.io/tls-acme: "true"
    nginx.ingress.kubernetes.io/rewrite-target: "<your-bucket-namespace>"
    nginx.ingress.kubernetes.io/secure-backends: "true"
  name: artifacts
spec:
  rules:
    - host: downloads.example.com
      http:
        paths:
          - path: "/artifacts/"
            backend:
              serviceName: proxy-artifacts
              servicePort: 443
  tls:
  - secretName: tls
    hosts:
    - downloads.example.com</code></pre>
<p>Lets quickly take a look at what is going on here. We first configure our Ingress Controller to use <em>nginx</em> and enable automatic provisioning via our cluster ACME/cert-manager.</p>
<p>Then we instruct nginx to rewrite the target URL to add the bucket. This way, we can swap buckets without the user facing URL having to change. (Notice to not include leading or trailing slashes)</p>
<p>Lastly we tell nginx, that the backend it should be expecting also is using TLS.</p>
<p>The rest of the ingress object is pretty standard. Define the hostname, the path and point it towards our service, that we will take a look at next.</p>
<pre class="wp-block-code"><code lang="yaml" class="language-yaml">apiVersion: v1
kind: Service
spec:
  externalName: storage.googleapis.com
  type: ExternalName
metadata:
  name: proxy-artifacts</code></pre>
<p>The service object is pretty standard. Notice that we don’t have to specify the port explicitly with this special kind of service. The externalName property simply is the hostname of what external system you want to talk to.</p>
<p>Deploy those two configurations and you should be all set. Once you have all the quirks figured out, this is actually really simple and saves you from operating any additional reverse proxies in- or outside your cluster. </p>
</div>
	</div>
	<footer class="entry-footer"><span class="cat-links"><i class="fa fa-folder-open" aria-hidden="true"></i><span class="screen-reader-text">Categories: </span><a href="https://liming.imfast.io/category/uncategorized" rel="category tag">默认分类</a></span>	</footer></article><nav class="navigation post-navigation" role="navigation" aria-label="Continue Reading"><h2 class="screen-reader-text">Continue Reading</h2>
		<div class="nav-links"><div class="nav-previous"><a href="https://liming.imfast.io/24.html" rel="prev"><span class="screen-reader-text">Previous Post</span><span aria-hidden="true" class="nav-subtitle">Previous</span> <span class="nav-title">ZSH shortcut: quickly commit using a function</span></a></div><div class="nav-next"><a href="https://liming.imfast.io/27.html" rel="next"><span class="screen-reader-text">Next Post</span><span aria-hidden="true" class="nav-subtitle">Next</span><span class="nav-title">Chase your Dreams</span></a></div></div>
	</nav>Comments are closed.<p class="no-comment"></p>			</main></div>
		<div id="secondary" class="col-md-3 primary-sidebar" role="complementary">
	<div class="widget-wrapper">
		<div id="search-2" class="widget widget_search">
<form role="search" method="get" class="search-form" action="https://liming.imfast.io/">
	<label for="search-input-5ea9837a92cbf">
		<span class="screen-reader-text">
			Search for:		</span>
	</label>
	<input type="text" id="search-input-5ea9837a92cbf" class="form-control" placeholder="Search …" value="" name="s"><button type="submit" class="btn btn-search">
		<i class="fa fa-search" aria-hidden="true"></i>
		<span class="screen-reader-text">
			Search		</span>
	</button>
</form>
</div>		<div id="recent-posts-2" class="widget widget_recent_entries">		<h2 class="widget-title">Recent Posts</h2>		<ul><li>
					<a href="https://liming.imfast.io/39.html">WordPress web converted to flat file S3 – Part 2</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/38.html">WordPress web converted to flat file S3 – Part 1</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/37.html">A wordpress site on S3 as flat files</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/36.html">AWS Web and MariaDB on EC2 in terraform modules</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/35.html">AWS Web and MariaDB on EC2 in one terraform template</a>
									</li>
					</ul></div><div id="recent-comments-2" class="widget widget_recent_comments"><h2 class="widget-title">Recent Comments</h2><ul id="recentcomments"></ul></div><div id="archives-2" class="widget widget_archive"><h2 class="widget-title">Archives</h2>		<ul><li><a href="https://liming.imfast.io/date/2020/04">April 2020</a></li>
		</ul></div><div id="categories-2" class="widget widget_categories"><h2 class="widget-title">Categories</h2>		<ul><li class="cat-item cat-item-1"><a href="https://liming.imfast.io/category/uncategorized">默认分类</a>
</li>
		</ul></div><div id="meta-2" class="widget widget_meta"><h2 class="widget-title">Meta</h2>			<ul><li><a href="https://liming.imfast.io/wp-login.php">Log in</a></li>
			<li><a href="https://liming.imfast.io/feed">Entries feed</a></li>
			<li><a href="https://liming.imfast.io/comments/feed">Comments feed</a></li>
			<li><a href="https://wordpress.org/">WordPress.org</a></li>			</ul></div>	</div>
</div>
	</div>
</div>
	</div>

	<footer id="colophon" class="site-footer"><div class="footer-widgets">
			<div class="container">
				<div class="row">
						<div class="col-md-4  widget-wrapper">
			</div>
	<div class="col-md-4  widget-wrapper">
				<div class="widget widget_recent_entries">		<h2 class="widgettitle">Recent Posts</h2>		<ul><li>
					<a href="https://liming.imfast.io/39.html">WordPress web converted to flat file S3 – Part 2</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/38.html">WordPress web converted to flat file S3 – Part 1</a>
									</li>
											<li>
					<a href="https://liming.imfast.io/37.html">A wordpress site on S3 as flat files</a>
									</li>
					</ul></div>	</div>
	<div class="col-md-4  widget-wrapper">
		<div class="widget widget_recent_comments"><h2 class="widgettitle">Recent Comments</h2><ul id="recentcomments--1"></ul></div>	</div>
				</div>	
			</div> 
		</div> 
		<div class="footer-social-copyright">	
			<div class="container">
				<div class="row">
						<div class="social-icons col-lg-6 col-md-6 col-sm-12 text-left">
		<ul class="list-inline footer-social-icons"></ul></div>
<div class="site-copyright col-lg-6 col-md-6 col-sm-12 text-right">
	Copyright © 2020<span class="sep"> | </span>
<a href="https://wordpress.org/">
	Proudly powered by WordPress</a>
</div>
				</div>	
			</div> 
		</div>	
	</footer></div>


 
		<button type="button" id="scroll-up" class="btn-scroll-up">
			<span class="screen-reader-text">Scroll up to top</span>
		</button> 


<script type="text/javascript" src="https://liming.imfast.io/wp-content/themes/friendly-lite//assets/js/bootstrap.min.js"></script><script type="text/javascript" src="https://liming.imfast.io/wp-content/themes/friendly-lite//assets/js/skip-link-focus-fix.js"></script><script type="text/javascript">
/* <![CDATA[ */
var friendly_lite_js_obj = {"site_preloader":"1","back_to_top":"1"};
/* ]]> */
</script><script type="text/javascript" src="https://liming.imfast.io/wp-content/themes/friendly-lite//assets/js/friendly-lite.js"></script></body></html>
